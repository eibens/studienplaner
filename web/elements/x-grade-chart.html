<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="data-model/data-model.html">
<link rel="import" href="x-grade-icon/x-grade-icon.html">

<dom-module id="x-grade-chart">
  <style>
    :host {
      @apply(--layout-horizontal);
    }
    .slot {
      @apply(--layout-vertical);
      @apply(--layout-self-stretch);
      @apply(--layout-center-center);
      padding: 16px 4px 4px 4px;
      transition: background 0.2s;
      border-radius: 3px;
    }
    .slot:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    .bar-container {
      @apply(--layout-flex);
      position: relative;
      width: 8px;
    }
    .bar {
      position: absolute;
      bottom: 0;
      right: 0;
      left: 0;
      background: rgba(0, 0, 0, 0.25);
      border-top-left-radius: 3px;
      border-top-right-radius: 3px;
    }
  </style>

  <template>
    <template
      is="dom-repeat"
      items="[[_bars]]">
      <div
        class="slot">
        <div
          class="bar-container">
          <div
            class="bar"
            style$="[[item.style]]">
          </div>
        </div>
        <x-grade-icon
          grade="[[item.grade]]"
          size="3">
        </x-grade-icon>
      </div>
    </template>
  </template>

  <script>
    Polymer({
      is: "x-grade-chart",

      properties: {
        attendances: {
          type: Array,
          value: []
        },
        _grades: {
          type: Array,
          value: [
            new Grade(1),
            new Grade(2),
            new Grade(3),
            new Grade(4),
            new Grade(5),
            null
          ]
        },
        _bars: {
          type: Array,
          computed: "_computeBars(attendances.*, _grades.*)"
        }
      },

      _computeBars: function (attendancesChange, gradesChange) {
        var items = this._mapGradesToCreditSum(
          gradesChange.base,
          attendancesChange.base
        );
        var maxCredits = this._maxArray(items.map(function (item) {
          return item.credits;
        }));
        return items.map(function (item) {
          item.percent = maxCredits > 0
            ? item.credits / maxCredits * 100
            : 0;
          item.style = "height:" + item.percent + "%;";
          return item;
        });
      },

      _mapGradesToCreditSum: function (grades, attendances) {
        var self = this;
        return grades.map(function (grade) {
          return {
            grade: grade,
            credits: self._sumCreditsByGrade(attendances, grade)
          };
        });
      },

      _maxArray: function (array) {
        var max = null;
        array.forEach(function (item) {
          if (max === null || max < item) {
            max = item;
          }
        });
        return max;
      },

      _sumCreditsByGrade: function (attendances, grade) {
        return this._sumCredits(this._filterByGrade(attendances, grade));
      },

      _sumCredits: function (attendances) {
        var sum = 0;
        attendances.forEach(function (attendance) {
          var credits = parseFloat(attendance.course.credits);
          if (!isNaN(credits)) {
            sum += parseFloat(attendance.course.credits);
          }
        });
        return sum;
      },

      _filterByGrade: function (attendances, grade) {
        var self = this;
        return attendances.filter(function (attendance) {
          return self._gradesEqual(grade, attendance.grade);
        });
      },

      _gradesEqual: function (gradeA, gradeB) {
        return gradeA == gradeB || gradeA && gradeA.equals(gradeB);
      }
    });
  </script>
</dom-module>
