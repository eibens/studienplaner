<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">

<dom-module id="x-stats">
  <style>
    header {
      font-size: 14px;
      font-weight: 200;
      color: rgba(0, 0, 0, 0.5);
    }
    header > * {
      cursor: pointer;
    }
    header iron-selector {
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      height: 48px;
    }
    header div {
      @apply(--layout-self-stretch);
      @apply(--layout-flex);
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      padding-top: 3px;
      border-bottom: 3px solid transparent;
    }
    header .iron-selected {
      border-color: rgba(0, 0, 0, 0.1);
    }
    header label {
      font-size: 14px;
      font-weight: bold;
      margin-right: 4px;
    }
    header label:after {
      content: ":";
    }
    header output {
      margin-right: 4px;
    }
    header output.total:before {
      content: "/";
      margin-right: 4px;
    }
  </style>

  <template>
    <header>
      <iron-selector
        selected="{{_modeIndex}}">
        <div>
          <label>Kurse</label>
          <output>[[_computeCount(_passed.*)]]</output>
          <output class="total">[[_computeCount(courses.*)]]</output>
        </div>
        <div>
          <label>ECTS</label>
          <output>[[_computeCredits(_passed.*)]]</output>
          <output class="total">[[_computeCredits(courses.*)]]</output>
        </div>
        <div>
          <label>Note</label>
          <output>[[_computeGrade(_passed.*)]]</output>
        </div>
      </iron-selector>
    </header>
  </template>

  <script>
    Polymer({
      is: "x-stats",

      properties: {
        courses: {
          type: Array,
          value: []
        },

        mode: {
          type: String,
          computed: "_computeMode(_modeIndex)"
        },

        _passed: {
          type: Array,
          computed: "_computePassedCourses(courses.*)"
        },

        _modeIndex: {
          type: Number,
          value: 0
        }
      },

      _computeMode: function (modeIndex) {
        return [
          "count",
          "credit",
          "grade"
        ][modeIndex];
      },

      _computePassedCourses: function (courseChange) {
        return courseChange.base.filter(function (course) {
          if (course.latestGrade == null) return false;
          return course.latestGrade.isPassing;
        });
      },

      _computeCount: function (change) {
        return change.base.length;
      },

      _computeCredits: function (change) {
        return change.base.reduce(function (sum, course) {
          return sum + parseFloat(course.credits);
        }, 0.0).toFixed(1);
      },

      _computeGrade: function (change) {
        var weightedSum = change.base.reduce(function (sum, course) {
          if (!course.hasGrade) return sum;
          return sum + parseFloat(course.credits) * course.latestGrade.value;
        }, 0.0);
        var credits = this._computeCredits(change);
        if (credits == 0) return "Keine";
        if (weightedSum == 0) return "Keine";
        return (weightedSum / credits).toFixed(2);
      }
    });
  </script>
</dom-module>
