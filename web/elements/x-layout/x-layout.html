<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">

<dom-module id="x-layout">
  <style>
    :root {
      --speed: 0.3s;
    }

    @media (min-width: 1581px) {
      :host([right-open]) #center {
        margin: 0 340px;
        transition: none;
      }
    }

    @media (min-width: 768px) and (max-width: 1580px) {
      :host([right-open]) #center {
        margin-right: 340px;
        transition: none;
      }
      :host([left-open]) #center {
        margin-left: 240px;
        transition: none;
      }
    }

    #fab {
      position: absolute;
      bottom: 24px;
      right: 32px;
      transition: transform var(--speed) var(--speed);
    }
    :host([right-open]) #fab {
      /* hide FAB when right is open */
      transform: scale(0);
      transition: transform var(--speed);
    }
    @media (max-width: 767px) {
      :host([left-open]) #fab {
        /* hide FAB when left is open */
        transform: scale(0);
        transition: transform var(--speed);
      }
    }

    @media (min-width: 768px) {

      /* on mobile normal scroll-bars should be used */
      ::-webkit-scrollbar {
        width: 8px;  /* for vertical scrollbars */
        height: 8px; /* for horizontal scrollbars */
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--divider-color);
      }

      #center {
        @apply(--layout-fit);
        overflow-y: auto;
      }
      #center .content {
        margin: auto;
        max-width: 900px;
        padding: 16px;
      }

      #left, #right {
        position: absolute;
        top: 0;
        bottom: 0;
        /* don't let column scroll directly since it may cause display problems
           of scroll-bars in combination with flex layout */
        overflow: hidden;
      }

      #left {
        left: 0;
        width: 240px;
        transform: translateX(-240px);
        transition: transform var(--speed);
        /* that way #center does not shine through when left is sliding out */
        background: var(--secondary-background-color);
      }
      #left[open] {
        transform: translateX(0);
      }
      #left .content {
        @apply(--layout-fit);
        overflow: hidden;
      }
      #left .content:hover {
        overflow-y: auto;
      }

      #right {
        right: 0;
        width: 340px;
        transform: translateX(340px);
        transition: transform var(--speed);
        background: var(--primary-background-color);
        @apply(--shadow-elevation-8dp);
      }
      #right[open] {
        transform: translateX(0);
      }
      #right .content {
        @apply(--layout-fit);
        overflow-y: auto;
      }
    }

    @media (max-width: 767px) {
      :host {
        /* otherwise #right is visible below #center */
        overflow: hidden;
      }

      #center {
        /* allows hiding the scroll-bar with overflow:hidden */
        @apply(--layout-fit);
      }
      :host([left-open]) #center {
        /* only #left scroll-bar should be visible */
        overflow: hidden;
      }

      #left {
        /* #left needs space for an overlay and has to cover whole screen */
        overflow: hidden;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        width: 100%;
        /* ignore input while it's not open */
        pointer-events: none;
      }
      #left[open] {
        pointer-events: all;
      }
      #left:before {
        /* use :before as overlay so we can animate opacity instead of background */
        @apply(--layout-fit);
        content: "";
        background: var(--disabled-text-color);
        opacity: 0;
        transition: opacity var(--speed);
      }
      #left[open]:before {
        opacity: 1;
      }
      #left .content {
        overflow-y: auto;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        max-width: 240px;
        background: var(--primary-background-color);
        /* move in from left */
        transform: translateX(-240px);
        transition: transform var(--speed);
      }
      #left[open] .content {
        transform: translateX(0);
        transition: transform var(--speed) var(--speed);
      }

      #right {
        overflow-y: auto;
        position: absolute;
        width: 100%;
        top: 0;
        right: 0;
        bottom: 0;
        background: var(--primary-background-color);
        /* move in from bottom */
        transform: translateY(100%);
        transition: transform var(--speed);
      }
      #right[open] {
        transform: translateY(0);
        transition: transform var(--speed);
      }
    }
  </style>

  <template>
    <iron-media-query
      query="(max-width: 767px)"
      query-matches="{{_narrow}}">
    </iron-media-query>
    <paper-header-panel id="panel">
      <paper-toolbar>
        <paper-icon-button
          class="menu-button"
          icon="menu"
          on-tap="toggleLeft">
        </paper-icon-button>
        <h1 class="title">Studienplaner</h1>
        <content select="[toolbar], .toolbar"></content>
      </paper-toolbar>
      <div id="body">
        <div
          id="center"
          class="container">
          <div class="content">
            <content select="[center], .center"></content>
          </div>
        </div>
        <div
          id="left"
          class="drawer container"
          open$="[[leftOpen]]"
          on-tap="_handleCloseLeft">
          <div
            class="content"
            on-tap="_stopPropagation">
            <content select="[left], .left"></content>
          </div>
        </div>
        <div
          id="right"
          class="drawer container"
          open$="[[rightOpen]]">
          <div class="content">
            <content select="[right], .right"></content>
          </div>
        </div>
      </div>
    </paper-header-panel>
    <paper-fab
      id="fab"
      icon="add"
      on-tap="_handleAction">
    </paper-fab>
  </template>

  <script>
    Polymer({
      is: "x-layout",

      properties: {
        leftOpen: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        rightOpen: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        _narrow: {
          type: Boolean,
          value: false,
          observer: "_narrowChanged"
        },

        _ready: {
          type: Boolean,
          value: false
        }
      },

      openLeft: function () {
        this.leftOpen = true;
      },

      openRight: function () {
        this.rightOpen = true;
      },

      closeLeft: function () {
        this.leftOpen = false;
      },

      closeRight: function () {
        this.rightOpen = false;
      },

      toggleLeft: function () {
        this.leftOpen = !this.leftOpen;
      },

      toggleRight: function () {
        this.rightOpen = !this.rightOpen;
      },

      ready: function () {
        this._ready = true;

        // Initialize the DOM to the current screen configuration.
        this._narrowChanged(this._narrow);
      },

      _narrowChanged: function (narrow) {
        // Make sure all elements are loaded before modifying the DOM.
        if (!this._ready) return;

        // NOTE: In narrow mode the right drawer should cover the whole screen,
        // including the toolbar. So when the screen is narrow simply move the
        // drawer outside #panel. Once the screen becomes wide again, move
        // #right back to its original location inside #body.
        if (narrow) {
          this.$.fab.parentNode.insertBefore(this.$.right, this.$.fab);
        } else {
          this.$.body.appendChild(this.$.right);
        }
      },

      _handleAction: function () {
        this.fire("action", {
          bubbles: true
        });
      },

      _handleCloseLeft: function (event) {
        event.stopPropagation();
        this.closeLeft();
      },

      _stopPropagation: function (event) {
        event.stopPropagation();
      }
    });
  </script>
</dom-module>
