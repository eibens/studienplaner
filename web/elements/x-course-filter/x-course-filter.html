<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="x-course-filter-behavior.html">

<dom-module id="x-course-filter">
  <script>
    Polymer({
      is: "x-course-filter",

      behaviors: [
        App.CourseFilterBehavior
      ],

      properties: {
        semester: {
          type: Object,
          value: null
        }
      },

      /**
       * Tests whether the course passes the filter using the current parameters.
       *
       * @param course
       * @returns boolean
       */
      test: function (course) {
        if (!course) course = {};
        var params = this.parameters;
        if (!params) return true;
        return this._testQuery(course.title, params.query) &&
            this._testWhiteList(course.type, params.allowedTypes) &&
            this._testWhiteList(this._computeGrade(course, this.semester), params.allowedGrades) &&
            this._testRequiredTags(course.tags, params.requiredTags) &&
            this._testForbiddenTags(course.tags, params.forbiddenTags);
      },

      _testQuery: function (title, query) {
        if (!query) return true;
        if (!title) title = "";
        title = title.toLowerCase();
        query = query.trim().toLowerCase();
        return title.indexOf(query) >= 0;
      },

      _testWhiteList: function (value, list) {
        var active = list instanceof Array && list.length > 0;
        if (!active) return true;
        return list.indexOf(value) >= 0;
      },

      _testRequiredTags: function (tags, required) {
        tags = tags || [];
        required = required || [];
        var match = true;
        required.forEach(function (required) {
          match = match && tags.indexOf(required) >= 0;
        });
        return match;
      },

      _testForbiddenTags: function (tags, forbidden) {
        tags = tags || [];
        forbidden = forbidden || [];
        var match = true;
        tags.forEach(function (tag) {
          match = match && forbidden.indexOf(tag) < 0;
        });
        return match;
      },

      _computeGrade: function (course, semester) {
        if (!course.attendances || course.attendances.length == 0) {
          return "none";
        }
        var latestAttendance = this._getLatestAttendance(course, semester) || {};
        var grade = latestAttendance.grade || null;
        return grade ? grade.toString() : null;
      },

      _getLatestAttendance: function (course, semester) {
        if (!course.attendances || course.attendances.length == 0) {
          return null;
        }
        return course.attendances.filter(function (item) {
          if (!semester) return true;
          return Semester.compare(item.semester, semester) <= 0;
        }).sort(function (a, b) {
          a = a || {};
          b = b || {};
          return -Semester.compare(a.semester, b.semester);
        })[0];
      }
    });
  </script>
</dom-module>
