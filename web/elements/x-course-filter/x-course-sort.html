<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="x-course-sort">
  <script>
    Polymer({
      is: "x-course-sort",

      properties: {

        /**
         * Value indicating the main sorting attribute.
         *
         * Per default it sorts by title, type. There are two other modes:
         *
         * - `credits` sorts by credits, grade, title, type
         * - `grade` sorts by grade, credits, title, type
         */
        mode: {
          type: String
        },

        semester: {
          type: Object,
          value: null
        }
      },

      compare: function (a, b) {
        switch (this.mode) {
          case "credits":
            return this._compare(a, b, [
              this._compareCredits,
              this._compareGrade,
              this._compareTitle,
              this._compareType
            ]);
          case "grade":
            return this._compare(a, b, [
              this._compareGrade,
              this._compareCredits,
              this._compareTitle,
              this._compareType
            ]);
          default:
            return this._compare(a, b, [
              this._compareTitle,
              this._compareType
            ]);
        }
      },

      _compareTitle: function (a, b) {
        return a.title.localeCompare(b.title);
      },

      _compareType: function (a, b) {
        return a.type.localeCompare(b.type);
      },

      _compareGrade: function (a, b) {
        var latestA = this._getLatestAttendance(a.attendances, this.semester);
        var latestB = this._getLatestAttendance(b.attendances, this.semester);
        if (!latestA && !latestB) return 0;
        if (!latestA) return 1;
        if (!latestB) return -1;
        if (!latestA.grade) return 1;
        if (!latestB.grade) return -1;
        return latestA.grade.value - latestB.grade.value;
      },

      _compareCredits: function (a, b) {
        return b.credits - a.credits;
      },

      _compare: function (a, b, comparators) {
        for (var i = 0; i < comparators.length; i++) {
          var delta = comparators[i].call(this, a, b);
          if (delta) {
            return delta;
          }
        }
        return 0;
      },

      _getLatestAttendance: function (attendances, semester) {
        if (!attendances || attendances.length == 0) {
          return null;
        }
        return attendances.filter(function (item) {
          if (!semester) return true;
          return Semester.compare(item.semester, semester) <= 0;
        }).sort(function (a, b) {
          a = a || {};
          b = b || {};
          return -Semester.compare(a.semester, b.semester);
        })[0];
      }
    });
  </script>
</dom-module>
