<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="x-course-type-filter.html">
<link rel="import" href="x-grade-filter.html">
<link rel="import" href="x-organizer-item.html">
<link rel="import" href="x-tag-filter.html">

<dom-module id="x-organizer">
  <style>
    :host {
      @apply(--layout-vertical);
      width: 240px;
      -webkit-user-select: none;
      user-select: none;
      padding: 0 8px;
      font-size: 14px;
      background: var(--default-background-color);
      color: var(--primary-text-color);
    }
    :host(::-webkit-scrollbar-thumb) {
      background: var(--divider-color);
    }
    section {
      @apply(--layout-vertical);
      border-top: 1px solid var(--divider-color);
      padding: 8px 0;
    }
    section:first-of-type {
      border-top: none !important;
    }
    section h1 {
      @apply(--paper-font-caption);
      margin: 8px 16px;
      color: var(--secondary-text-color);
    }
    section .placeholder {
      margin: 8px 16px;
      color: var(--disabled-text-color);
      font-style: italic;
    }
    input {
      display: block;
      border: none;
      outline: none;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 3px;
      background: var(--highlight-color);
      margin: 12px 8px;
      color: var(--primary-text-color);
      transition: background 0.2s;
      opacity: 0.75;
    }
    x-organizer-item {
      margin-bottom: 1px;
    }
    x-organizer-item:last-of-type {
      margin-bottom: 0;
    }
    input:hover, input:focus {
      background: var(--selection-color);
    }
    input::-webkit-input-placeholder {
      color: var(--secondary-text-color);
      font-style: italic;
    }
    x-course-type-filter {
      padding-left: 16px;
    }
  </style>

  <template>
    <section class="first">
      <x-organizer-item
        text="Kurse"
        on-tap="_handleListMode"
        selected="[[!semesterActive]]">
        <iron-icon
          icon="reorder">
        </iron-icon>
      </x-organizer-item>
      <x-organizer-item
        text="Semester"
        on-tap="_handleSemesterMode"
        selected="[[semesterActive]]">
        <iron-icon
          icon="editor:insert-chart">
        </iron-icon>
      </x-organizer-item>
    </section>

    <section>
      <input value="{{query::input}}" placeholder="Suchtext"/>
    </section>

    <section>
      <h1>Kurstypen</h1>
      <span
        hidden$="[[!_empty(types.*)]]"
        class="placeholder">
        Keine Kurstypen
      </span>
      <x-course-type-filter
        hidden$="[[_empty(types.*)]]"
        items="[[types]]"
        selected="{{selectedTypes}}">
      </x-course-type-filter>
    </section>

    <section>
      <h1>Teilnahmen</h1>
      <span
        hidden$="[[!_empty(grades.*)]]"
        class="placeholder">
        Keine Noten
      </span>
      <x-grade-filter
        hidden$="[[_empty(grades.*)]]"
        items="[[grades]]"
        selected="{{selectedGrades}}">
      </x-grade-filter>
    </section>

    <section>
      <h1>Kategorien</h1>
      <span
        hidden$="[[!_empty(tags.*)]]"
        class="placeholder">
        Keine Kategorien
      </span>
      <x-tag-filter
        hidden$="[[_empty(tags.*)]]"
        items="[[tags]]"
        required="{{requiredTags}}"
        forbidden="{{forbiddenTags}}">
      </x-tag-filter>
    </section>
  </template>

  <script>
    Polymer({
      is: "x-organizer",

      properties: {

        /**
         * Courses that are managed by this organizer.
         */
        courses: {
          type: Array,
          value: []
        },

        /**
         * Types collected from the `courses` array.
         */
        types: {
          type: Array,
          computed: "_computeTypes(courses.*)"
        },

        /**
         * Grades collected from the `courses` array.
         */
        grades: {
          type: Array,
          computed: "_computeGrades(courses.*)"
        },

        /**
         * Tags collected from the `courses` array.
         */
        tags: {
          type: Array,
          computed: "_computeTags(courses.*)"
        },

        /**
         * Current search query.
         */
        query: {
          type: String,
          value: "",
          notify: true
        },

        /**
         * Array of selected course types.
         */
        selectedTypes: {
          type: Array,
          value: [],
          notify: true
        },

        /**
         * Array of selected grades.
         */
        selectedGrades: {
          type: Array,
          value: [],
          notify: true
        },

        /**
         * Array of required tags.
         */
        requiredTags: {
          type: Array,
          value: [],
          notify: true
        },

        /**
         * Array of forbidden tags.
         */
        forbiddenTags: {
          type: Array,
          value: [],
          notify: true
        },

        /**
         * Value indicating that the semester filter is active.
         */
        semesterActive: {
          type: Boolean,
          value: false,
          notify: true
        }
      },

      reset: function () {
        this.set("query", "");
        this.set("selectedTypes", []);
        this.set("selectedGrades", []);
        this.set("requiredTags", []);
        this.set("forbiddenTags", []);
        this.set("semesterActive", false);
      },


      _handleListMode: function () {
        this.set("semesterActive", false);
      },

      _handleSemesterMode: function () {
        this.set("semesterActive", true);
      },

      _empty: function (arrayChange) {
        return !arrayChange.base || arrayChange.base.length === 0;
      },

      _computeTypes: function (coursesChange) {
        var courses = coursesChange.base;
        if (!(courses instanceof Array)) return [];
        var types = [];
        courses.forEach(function (course) {
          var type = course.type || null;
          if (types.indexOf(type) < 0) {
            types.push(type);
          }
        });
        return types;
      },

      _computeGrades: function (coursesChange) {
        var courses = coursesChange.base;
        if (!(courses instanceof Array)) return [];
        var grades = [];
        courses.map(function (course) {
          var grade = course.grade !== undefined ? course.grade : "none";
          if (grade) {
            if (["1", "2", "3", "4", "5", "none"].indexOf(grade.toString()) < 0) {
              grade = null;
            }
          }
          if (grades.indexOf(grade) < 0) {
            grades.push(grade);
          }
        });
        return grades;
      },

      _computeTags: function (coursesChange) {
        var courses = coursesChange.base;
        if (!(courses instanceof Array)) return [];
        var tags = [];
        courses.forEach(function (course) {
          if (!(course.tags instanceof Array)) return;
          course.tags.forEach(function (tag) {
            if (tags.indexOf(tag) < 0) {
              tags.push(tag);
            }
          });
        });
        return tags;
      },

      _contains: function (array, val, comparer) {
        for (var i = 0; i < array.length; i++) {
          if (comparer(array[i], val)) {
            return true;
          }
        }
        return false;
      }
    });
  </script>
</dom-module>
