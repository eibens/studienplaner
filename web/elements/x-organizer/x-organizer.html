<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../data-model/data-model.html">
<link rel="import" href="x-course-type-filter.html">
<link rel="import" href="x-grade-filter.html">
<link rel="import" href="x-organizer-item.html">
<link rel="import" href="x-tag-filter.html">

<dom-module id="x-organizer">
  <style>
    :host {
      @apply(--layout-vertical);
      @apply(--layout-flex);
      @apply(--layout-self-stretch);
      -webkit-user-select: none;
      user-select: none;
      padding: 0 8px;
      font-size: 14px;
      background: var(--default-background-color);
      color: var(--primary-text-color);
    }
    :host(::-webkit-scrollbar-thumb) {
      background: var(--divider-color);
    }
    section {
      @apply(--layout-vertical);
      border-top: 1px solid var(--divider-color);
      padding: 8px 0;
    }
    section:first-of-type {
      border-top: none !important;
    }
    h1 {
      @apply(--paper-font-caption);
      margin: 8px 16px 8px 16px;
      color: var(--secondary-text-color);
    }
    input {
      display: block;
      border: none;
      outline: none;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 3px;
      background: var(--highlight-color);
      margin: 12px 8px;
      color: var(--primary-text-color);
      transition: background 0.2s;
      opacity: 0.75;
    }
    x-organizer-item {
      margin-bottom: 1px;
    }
    x-organizer-item:last-of-type {
      margin-bottom: 0;
    }
    input:hover, input:focus {
      background: var(--selection-color);
    }
    input::-webkit-input-placeholder {
      color: var(--secondary-text-color);
      font-style: italic;
    }
    x-course-type-filter {
      padding-left: 16px;
    }
  </style>

  <template>
    <section class="first">
      <x-organizer-item
        text="Kurse"
        on-tap="_handleListMode"
        selected="[[!filter.semester.enabled]]">
        <iron-icon
          icon="reorder">
        </iron-icon>
      </x-organizer-item>
      <x-organizer-item
        text="Semester"
        on-tap="_handleSemesterMode"
        selected="[[filter.semester.enabled]]">
        <iron-icon
          icon="editor:insert-chart">
        </iron-icon>
      </x-organizer-item>
    </section>
    <section>
      <input value="{{filter.query::input}}" placeholder="Suchtext"/>
    </section>
    <section>
      <h1>Kurstypen</h1>
      <x-course-type-filter
        items="[[_types]]"
        selected="{{filter.types.allowed}}">
      </x-course-type-filter>
    </section>
    <section>
      <h1>Bewertungen</h1>
      <x-grade-filter
        selected="{{filter.grades.allowed}}">
      </x-grade-filter>
    </section>
    <section>
      <h1>Kategorien</h1>
      <x-tag-filter
        items="[[_tags]]"
        required="{{filter.tags.required}}"
        forbidden="{{filter.tags.forbidden}}">
      </x-tag-filter>
    </section>
  </template>

  <script>
    Polymer({
      is: "x-organizer",

      properties: {

        courses: {
          type: Array,
          value: []
        },

        filter: {
          type: Object,
          value: new Filter(),
          notify: true
        },

        _types: {
          type: Array,
          computed: "_computeTypes(courses.*)"
        },

        _tags: {
          type: Array,
          computed: "_computeTags(courses.*)"
        }
      },

      _computeTypes: function (courseChange) {
        var courses = courseChange.base;
        if (!courses) return [];
        var types = [];
        courses.forEach(function (course) {
          if (types.indexOf(course.type) < 0) {
            types.push(course.type);
          }
        });
        return types;
      },

      _computeTags: function (courseChange) {
        var courses = courseChange.base;
        if (!courses) return [];
        var tags = [];
        courses.forEach(function (course) {
          course.tags.forEach(function (tag) {
            if (tags.indexOf(tag) < 0) {
              tags.push(tag);
            }
          });
        });
        return tags;
      },

      _handleListMode: function () {
        this.set("filter.semester.enabled", false);
      },

      _handleSemesterMode: function () {
        this.set("filter.semester.enabled", true);
      }
    });
  </script>
</dom-module>
