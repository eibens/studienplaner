<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="x-grade-icon/x-grade-icon.html">

<dom-module id="x-course-grade">
  <style>
    :host {
      @apply(--layout-horizontal);
      @apply(--layout-end-justified);
    }
    x-grade-icon {
      margin-left: 4px;
    }
    :host([_empty]) x-grade-icon {
      background: rgba(0, 0, 0, 0.1);
      border: none;
    }
  </style>

  <template>
    <x-grade-icon
      id="icon"
      grade="[[_latestAttendance.grade]]"
      size="[[size]]"
      interactive
      on-tap="_handleTap">
    </x-grade-icon>
  </template>

  <script>
    Polymer({
      is: "x-course-grade",

      properties: {
        course: {
          type: Object,
          value: null
        },
        size: {
          type: Number,
          value: 3
        },
        _empty: {
          type: Boolean,
          computed: "_computeEmpty(_latestAttendance)",
          reflectToAttribute: true
        },
        _multiple: {
          type: Boolean,
          value: false
        },
        _latestAttendance: {
          type: Object,
          value: null
        }
      },

      observers: [
        "_handleChange(course.*)",
        "_handleShadowChanged(size, _multiple)"
      ],

      _handleChange: function (courseChange) {
        var course = courseChange.base;
        var attendances = course.attendances.sort(function (a, b) {
          return Semester.compare(b.semester, a.semester);
        });
        var count = attendances.length;
        this._multiple = count > 1;
        // Make sure latest attendance is definitely updated, since the path
        // binding is broken after we filter and sort the attendance array.
        this._latestAttendance = null;
        this._latestAttendance = count > 0 ? attendances[0] : null;
      },

      _handleShadowChanged: function (size, multiple) {
        this.$.icon.style.boxShadow = "none";
        if (multiple) {
          this.$.icon.style.boxShadow = "-" + size + "px " + size + "px " +
            "rgba(0, 0, 0, 0.15)";
        }
      },

      _computeEmpty: function (attendance) {
        return !attendance;
      },

      _handleTap: function (event) {
        if (!this._latestAttendance) return;
        this.fire("select-attendance", {
          data: this._latestAttendance
        });
        event.stopPropagation();
      },

      _handleDown: function (event) {
        // Prevent ripple in parent.
        event.stopPropagation();
      }
    });
  </script>
</dom-module>
