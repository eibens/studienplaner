<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="x-grade-icon.html">

<dom-module id="x-course-grade">
  <style>
    :host {
      @apply(--layout-horizontal);
      @apply(--layout-end-justified);
    }
    x-grade-icon {
      margin-left: 4px;
    }
  </style>

  <template>
    <x-grade-icon
      grade="[[_latestAttendance.grade]]"
      size="3"
      interactive
      multiple="[[_multipleAttendances]]"
      on-tap="_handleTap">
    </x-grade-icon>
  </template>

  <script>
    Polymer({
      is: "x-course-grade",

      properties: {
        course: {
          type: Object,
          value: null
        },
        attendances: {
          type: Array,
          value: []
        },
        _courseAttendances: {
          type: Array,
          computed: "_computeCourseAttendances(course, attendances.*)"
        },
        _latestAttendance: {
          type: Object,
          computed: "_computeLatestAttendance(_courseAttendances.*)"
        },
        _attendanceCount: {
          type: Boolean,
          computed: "_computeAttendanceCount(_courseAttendances.*)"
        },
        _noAttendances: {
          type: Boolean,
          computed: "_computeNoAttendances(_attendanceCount)"
        },
        _multipleAttendances: {
          type: Boolean,
          computed: "_computeMultipleAttendances(_attendanceCount)"
        }
      },

      _computeCourseAttendances: function (course) {
        return this.attendances.filter(function (attendance) {
          return attendance.course.id == course.id;
        });
      },

      _computeLatestAttendance: function (changes) {
        if (this.empty) return null;
        return changes.base.sort(function (a, b) {
          return Semester.compare(b.semester, a.semester);
        })[0];
      },

      _computeAttendanceCount: function (changes) {
        return changes.base.length;
      },

      _computeNoAttendances: function (count) {
        return count == 0;
      },

      _computeMultipleAttendances: function (count) {
        return count > 1;
      },

      _handleTap: function (event) {
        if (this._noAttendances) return;
        this.fire("select-attendance", {
          data: this._latestAttendance
        });
        event.stopPropagation();
      },

      _handleDown: function (event) {
        // Prevent ripple in parent.
        event.stopPropagation();
      }
    });
  </script>
</dom-module>
