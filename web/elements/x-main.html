<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="data-model/data-model.html">
<link rel="import" href="data-manager.html">
<link rel="import" href="x-browser.html">
<link rel="import" href="x-course-inspector.html">
<link rel="import" href="x-attendance-inspector.html">
<link rel="import" href="x-toolbar.html">
<link rel="import" href="x-organizer/x-organizer.html">

<dom-module id="x-main">
  <style>
    :root {
      --default-primary-color: #d81b60;
    }
    :host {
      @apply(--layout-fit);
      @apply(--layout-vertical);
    }
    main {
      @apply(--layout-flex);
      @apply(--layout-horizontal);
    }
    main > x-browser {
      @apply(--layout-flex);
    }
    aside {
      position: relative;
      width: 320px;
    }
    x-course-inspector {
      @apply(--layout-fit);
    }
    x-attendance-inspector {
      @apply(--layout-fit);
    }
    paper-fab {
      position: absolute;
      bottom: 16px;
      right: 16px;
    }
    x-organizer {
      margin: 8px;
    }
  </style>

  <template>
    <data-manager
      id="data"
      profile="{{profile}}"
      dirty="{{_storageDirty}}"
      empty="{{_profileEmpty}}">
    </data-manager>
    <array-selector
      id="course"
      items="{{profile.courses}}"
      selected="{{course}}">
    </array-selector>
    <array-selector
      id="attendance"
      items="{{profile.attendances}}"
      selected="{{attendance}}">
    </array-selector>

    <x-toolbar
      name="{{profile.name}}"
      saving="[[_storageDirty]]"
      cleared="[[_profileEmpty]]">
    </x-toolbar>

    <main>
      <x-organizer
        id="element"
        types='[null, "VU", "VO", "UE", "PR"]'
        tags='["Red", "Blue", "Green", "Gold", "Brown", "Yellow"]'>
      </x-organizer>
      <x-browser
        class="main"
        courses="{{profile.courses}}"
        attendances="[[profile.attendances]]">
      </x-browser>
      <aside hidden$="[[_areEmpty(course, attendance)]]">
        <x-course-inspector
          hidden$="[[_isEmpty(course)]]"
          course="{{course}}"
          attendances="{{profile.attendances}}">
        </x-course-inspector>
        <x-attendance-inspector
          hidden$="[[_isEmpty(attendance)]]"
          attendance="{{attendance}}">
        </x-attendance-inspector>
      </aside>
    </main>

    <paper-fab
      icon="add"
      on-tap="_handleAddButtonTap">
    </paper-fab>
  </template>

  <script>
    Polymer({
      is: "x-main",

      properties: {
        profile: {
          type: Object
        },
        course: {
          type: Object,
          value: null
        },
        attendance: {
          type: Object,
          value: null
        },
        _storageDirty: {
          type: Boolean
        },
        _profileEmpty: {
          type: Boolean
        }
      },

      listeners: {
        "import-profile": "_handleImportProfile",
        "export-profile": "_handleExportProfile",
        "delete-profile": "_handleDeleteProfile",
        "add-course": "_handleAddCourse",
        "select-course": "_handleSelectCourse",
        "delete-course": "_handleDeleteCourse",
        "add-attendance": "_handleAddAttendance",
        "select-attendance": "_handleSelectAttendance",
        "delete-attendance": "_handleDeleteAttendance",
        "add-course-tag": "_handleAddCourseTag"
      },

      _handleAddButtonTap: function (event) {
        this.fire("add-course");
      },

      _handleExportProfile: function () {
        this.$.data.export();
      },
      _handleImportProfile: function () {
        this.$.data.import();
      },
      _handleDeleteProfile: function () {
        var result = window.confirm("Willst du deine Daten wirklich lÃ¶schen?");
        if (!result) return;
        this.$.data.clear();
      },

      _handleAddCourse: function () {
        var course = new Course(this.profile.generateCourseId());
        this._add("profile.courses", course);
        this.fire("select-course", { data: course });
      },
      _handleSelectCourse: function (event) {
        var course = event.detail.data;
        this._select("profile.courses", course, this.$.course);
        if (course) {
          this.fire("select-attendance", { data: null });
        }
      },
      _handleDeleteCourse: function (event) {
        var course = event.detail.data;
        this._remove("profile.courses", event.detail.data, this.$.course);

        // Delete associated attendances as well.
        var self = this;
        var attendances = this.profile.attendances.filter(function (attendance) {
          return course == attendance.course;
        });
        attendances.forEach(function (attendance) {
          self.fire("delete-attendance", { data: attendance});
        });
      },

      _handleAddAttendance: function (event) {
        var attendance = new Attendance(
          this.profile.generateAttendanceId(),
          event.detail.course
        );
        this._add("profile.attendances", attendance);
        this.fire("select-attendance", { data: attendance });
      },
      _handleSelectAttendance: function (event) {
        var attendance = event.detail.data;
        this._select("profile.attendances", attendance, this.$.attendance);
        if (attendance) {
          this.fire("select-course", { data: null });
        }
      },
      _handleDeleteAttendance: function (event) {
        var attendance = event.detail.data;
        this._remove("profile.attendances", attendance, this.$.attendance);
        this.fire("select-course", {
          data: attendance.course
        });
      },

      _handleAddCourseTag: function (event) {
        var course = event.detail.course;
        var tag = event.detail.tag;
        if (course.tags.indexOf(tag) >= 0) return;
        var index = this.profile.courses.indexOf(course);
        this.push("profile.courses." + index + ".tags", tag);
      },

      _add: function (path, item, selector) {
        if (this.get(path).indexOf(item) >= 0) {
          throw new Error("Item already added.");
        }
        this.push(path, item);
      },
      _select: function (path, item, selector) {
        if (item != null && this.get(path).indexOf(item) < 0) {
          throw new Error("Cannot select unknown item.");
        }
        selector.select(item);
      },
      _remove: function (path, item, selector) {
        if (this.get(path).indexOf(item) < 0) {
          throw new Error("Cannot delete unknown item.");
        }
        var index = this.get(path).indexOf(item);
        this.splice(path, index, 1);
        if (selector.selected == item) {
          selector.select(null);
        }
      },

      _isEmpty: function (object) {
        return !object;
      },
      _areEmpty: function () {
        for (var i = 0; i < arguments.length; i++) {
          if (arguments[i]) return false;
        }
        return true;
      }
    });
  </script>
</dom-module>
