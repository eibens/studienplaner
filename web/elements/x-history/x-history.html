<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="x-history">
  <script>
    Polymer({
      is: "x-history",

      properties: {
        courses: {
          type: Array
        }
      },

      ready: function () {
        var self = this;
        window.addEventListener("popstate", function (event) {
          self._processState(event.state);
        });
      },

      selectCourse: function (course) {
        var url = "#";
        var state = {};
        if (course) {
          state = {
            course: course.id
          };
          url = this._buildUrl([
            "kurs", course.id.toString()
          ]);
        }
        this._pushState(state, url);
      },

      selectAttendance: function (attendance) {
        var url = "#";
        var state = {};
        if (attendance) {
          state = {
            course: attendance.course.id,
            attendance: attendance.id
          };
          url = this._buildUrl([
            "kurs", attendance.course.id.toString(),
            "teilnahme", attendance.id.toString()
          ]);
        }
        this._pushState(state, url);
      },

      openOrganizer: function () {
        this._pushState("organizer", "#menu");
      },

      _pushState: function (state, url) {
        if (window.history.state == "organizer") {
          window.history.replaceState(state, "", url);
        } else {
          window.history.pushState(state, "", url);
        }
      },

      _processState: function (state) {
        this.fire("close-organizer");
        if (!state) state = {};
        var course = this._getCourseById(this.courses, state.course);
        if (!course) {
          this.fire("close-inspector");
        } else {
          var attendance = this._getAttendanceById(course.attendances, state.attendance);
          if (attendance) {
            this.fire("select-attendance", {
              data: attendance,
              history: true
            });
          } else {
            this.fire("select-course", {
              data: course,
              history: true
            });
          }
        }
      },

      _getCourseById: function (courses, id) {
        if (!courses) return null;
        if (!id) return null;
        for (var i = 0; i < courses.length; i++) {
          if (courses[i].id == id) {
            return courses[i];
          }
        }
        return null;
      },

      _getAttendanceById: function (attendances, id) {
        if (!attendances) return null;
        if (!id) return null;
        for (var i = 0; i < attendances.length; i++) {
          if (attendances[i].id == id) {
            return attendances[i];
          }
        }
        return null;
      },

      _buildUrl: function (parts) {
        return "#" + parts.join("-");
      }
    });
  </script>
</dom-module>
