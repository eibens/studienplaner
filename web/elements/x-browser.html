<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="x-course-list-item.html">
<link rel="import" href="x-grade-chart.html">
<link rel="import" href="x-stats/x-stats.html">
<link rel="import" href="x-semester-picker.html">

<dom-module id="x-browser">
  <style>
    :host {
      @apply(--layout-vertical);
    }
    header {
      height: 40px;
      width: 100%;
    }
    main {
      @apply(--layout-vertical);
      width: 100%;
      padding-bottom: 8px;
    }
    .placeholder {
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      margin: 2em;
    }
    x-stats {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      margin-bottom: 8px;
    }

    @media (min-width: 768px) {
      main {
        @apply(--shadow-elevation-3dp);
        background: var(--primary-background-color);
      }
    }
  </style>

  <template>
    <header
      hidden$="[[!filter.semester.enabled]]">
      <x-semester-picker
        value="{{filter.semester.value}}">
      </x-semester-picker>
    </header>
    <main
      hidden$="[[empty]]">
      <x-stats
        courses="[[result]]"
        mode="{{_sortMode}}">
      </x-stats>
      <template
        id="list"
        is="dom-repeat"
        items="{{courses}}"
        filter="_filter"
        sort="_sort"
        observe="type title credits">
        <x-course-list-item
          course="[[item]]">
        </x-course-list-item>
      </template>
    </main>
    <div
      class="placeholder"
      hidden$="[[!empty]]">
      Keine Kurse gefunden
    </div>
  </template>

  <script>
    Polymer({
      is: "x-browser",

      properties: {
        courses: {
          type: Array,
          value: []
        },

        filter: {
          type: Object,
          value: null
        },

        result: {
          type: Array,
          computed: "_computeResult(courses.*, filter.*)"
        },

        empty: {
          type: Boolean,
          computed: "_computeEmpty(result)"
        },

        _sortMode: {
          type: String,
          observer: "_render"
        },

        _filterActive: {
          type: Boolean,
          computed: "_computeFilterActive(filter.*)"
        }
      },

      observers: [
        "_render(filter.*)"
      ],

      _render: function () {
        this.$.list.render();
      },

      _resetFilter: function () {
        this.filter = new Filter();
      },

      _computeResult: function () {
        var self = this;
        return this.courses.filter(function (course) {
          return self._filter(course);
        });
      },

      _computeFilterActive: function (filterChange) {
        // TODO
        return false;
      },

      _computeEmpty: function () {
        return this.result.length === 0;
      },

      _filter: function (course) {
        return this.filter.test(course);
      },

      _sort: function (a, b) {
        switch (this._sortMode) {
          case "credit":
            return this._compare(a, b, [
              this._compareCredits,
              this._compareGrade,
              this._compareTitle,
              this._compareType
            ]);
          case "grade":
            return this._compare(a, b, [
              this._compareGrade,
              this._compareCredits,
              this._compareTitle,
              this._compareType
            ]);
          default:
            return this._compare(a, b, [
              this._compareTitle,
              this._compareType
            ]);
        }
      },

      _compareTitle: function (a, b) {
        return a.title.localeCompare(b.title);
      },

      _compareType: function (a, b) {
        return a.type.localeCompare(b.type);
      },

      _compareGrade: function (a, b) {
        if (a.grade == b.grade) return 0;
        if (a.grade == "none") return 1;
        if (b.grade == "none") return -1;
        if (!a.grade) return 1;
        if (!b.grade) return -1;
        return a.grade.toString().localeCompare(b.grade.toString());
      },

      _compareCredits: function (a, b) {
        return b.credits - a.credits;
      },

      _compare: function (a, b, comparators) {
        for (var i = 0; i < comparators.length; i++) {
          var delta = comparators[i](a, b);
          if (delta) {
            return delta;
          }
        }
        return 0;
      }
    });
  </script>
</dom-module>
