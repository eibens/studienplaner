<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="x-course-list-item.html">
<link rel="import" href="x-grade-chart.html">
<link rel="import" href="x-stats/x-stats.html">
<link rel="import" href="x-semester-picker.html">

<dom-module id="x-browser">
  <style>
    :host {
      @apply(--layout-vertical);
      @apply(--layout-center);
      overflow-y: scroll;
    }
    .wrapper {
      width: 90%;
      max-width: 1000px;
      padding: 16px 0;
    }

    main {
      @apply(--layout-vertical);
      background: white;
      @apply(--shadow-elevation-3dp);
      margin: 16px 0;
      padding-bottom: 8px;
    }
    .placeholder {
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      margin: 2em;
    }
    x-stats {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      margin-bottom: 8px;
    }
    header {
      height: 40px;
      width: 100%;
    }
  </style>

  <template>
    <div class="wrapper">
      <header
        hidden$="[[!filter.semester.enabled]]">
        <x-semester-picker
          value="{{filter.semester.value}}">
        </x-semester-picker>
      </header>
      <main>
        <x-stats
          courses="[[result]]"
          mode="{{_sortMode}}">
        </x-stats>
        <template
          id="list"
          is="dom-repeat"
          items="{{courses}}"
          filter="_filter"
          sort="_sort"
          observe="type title credits">
          <x-course-list-item
            course="[[item]]">
          </x-course-list-item>
        </template>
        <div
          class="placeholder"
          hidden$="[[!empty]]">
          Keine Kurse gefunden
        </div>
      </main>
    </div>
  </template>

  <script>
    Polymer({
      is: "x-browser",

      properties: {
        courses: {
          type: Array,
          value: []
        },

        filter: {
          type: Object,
          value: null
        },

        result: {
          type: Array,
          computed: "_computeResult(courses.*, filter.*)"
        },

        empty: {
          type: Boolean,
          computed: "_computeEmpty(result)"
        },

        _sortMode: {
          type: String,
          observer: "_render"
        }
      },

      observers: [
        "_render(filter.*)"
      ],

      _render: function () {
        this.$.list.render();
      },

      _computeResult: function () {
        var self = this;
        return this.courses.filter(function (course) {
          return self._filter(course);
        });
      },

      _computeEmpty: function () {
        return this.result.length === 0;
      },

      _filter: function (course) {
        return this.filter.test(course);
      },

      _sort: function (a, b) {
        switch (this._sortMode) {
          case "credit":
            return this._compare(a, b, [
              this._compareCredits,
              this._compareGrade,
              this._compareTitle,
              this._compareType
            ]);
          case "grade":
            return this._compare(a, b, [
              this._compareGrade,
              this._compareCredits,
              this._compareTitle,
              this._compareType
            ]);
          default:
            return this._compare(a, b, [
              this._compareTitle,
              this._compareType
            ]);
        }
      },

      _compareTitle: function (a, b) {
        return a.title.localeCompare(b.title);
      },

      _compareType: function (a, b) {
        return a.type.localeCompare(b.type);
      },

      _compareGrade: function (a, b) {
        var gradeA = a.hasGrade ? a.latestGrade.value : 6;
        var gradeB = b.hasGrade ? b.latestGrade.value : 6;
        return gradeA - gradeB;
      },

      _compareCredits: function (a, b) {
        return b.credits - a.credits;
      },

      _compare: function (a, b, comparators) {
        for (var i = 0; i < comparators.length; i++) {
          var delta = comparators[i](a, b);
          if (delta) {
            return delta;
          }
        }
        return 0;
      }
    });
  </script>
</dom-module>
