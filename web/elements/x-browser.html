<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="x-course-list-item.html">
<link rel="import" href="x-grade-chart.html">
<link rel="import" href="x-stats/x-stats.html">

<dom-module id="x-browser">
  <style>
    :host {
      @apply(--layout-vertical);
      @apply(--layout-center);
      overflow-x: hidden;
      overflow-y: auto;
    }
    .wrapper {
      width: 90%;
      max-width: 1000px;
      padding: 16px 0;
    }

    main {
      @apply(--layout-vertical);
      background: white;
      @apply(--shadow-elevation-3dp);
      margin: 16px 0;
      padding-bottom: 8px;
    }
    .placeholder {
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
      margin: 2em;
    }
    x-stats {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      margin-bottom: 8px;
    }
  </style>

  <template>
    <div class="wrapper">
      <paper-input
        label="Suchbegriff"
        value="{{query}}">
      </paper-input>

      <main>
        <x-stats
          courses="[[result]]">
        </x-stats>
        <template
          id="list"
          is="dom-repeat"
          items="{{courses}}"
          filter="_filter"
          sort="_sort"
          observe="type title credits">
          <x-course-list-item
            course="[[item]]">
          </x-course-list-item>
        </template>
        <div
          class="placeholder"
          hidden$="[[!empty]]">
          Keine Kurse gefunden
        </div>
      </main>
    </div>

  </template>

  <script>
    Polymer({
      is: "x-browser",

      properties: {
        courses: {
          type: Array,
          value: []
        },

        filter: {
          type: Object,
          value: null
        },

        query: {
          type: String,
          value: null,
          observer: "_handleFilterChanged"
        },

        result: {
          type: Array,
          computed: "_computeResult(courses.*, filter.*, query)"
        },

        empty: {
          type: Boolean,
          computed: "_computeEmpty(result)"
        }
      },

      observers: [
        "_handleFilterChanged(filter.*)"
      ],

      _handleFilterChanged: function () {
        this.$.list.render();
      },

      _computeResult: function () {
        var self = this;
        return this.courses.filter(function (course) {
          return self._filter(course);
        });
      },

      _computeEmpty: function () {
        return this.result.length === 0;
      },

      _filter: function (course) {
        if (this.query) {
          var title = course.title.toLowerCase();
          var query = this.query.toLowerCase();
          var match = title.indexOf(query) >= 0;
          if (!match) return false;
        }
        return this.filter.test(course);
      },

      _sort: function (a, b) {
        return a.title.localeCompare(b.title);
      }
    });
  </script>
</dom-module>
